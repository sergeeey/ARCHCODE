# RS-08: TAD Boundary Stability Variation (95% vs 30%)

## Research Question

**Почему одни границы TAD стабильны в 95% клеток, а другие — только в 30%?**

### Problem Statement

Экспериментальные данные показывают, что:
- **Высокостабильные границы** (90-95% воспроизводимость между клетками):
  - Часто ассоциированы с сильными CTCF сайтами
  - Обогащены G4-структурами
  - Низкое метилирование CpG
  - Консервативные TE мотивы

- **Вариабельные границы** (30-50% воспроизводимость):
  - Слабые или отсутствующие CTCF сайты
  - Высокое метилирование
  - Конфликтующие non-B DNA структуры
  - Нестабильные TE insertions

**Вопрос:** Какие факторы определяют эту разницу? Можно ли предсказать стабильность границы по её геномным признакам?

---

## Current ARCHCODE Model

### RS-06: Boundary Stability Predictor

**Формула стабильности:**
```
Stability = S_ctcf × (1 + E_barrier) × E_epi × (1 + M_te) × T_time
```

**Где:**
- `S_ctcf`: CTCF strength (0-1)
- `E_barrier`: Energy barrier contribution (G4, Z-DNA, R-loops)
- `E_epi`: Epigenetic factor (methylation, histone marks)
- `M_te`: TE motif effects
- `T_time`: Temporal order probability

**Категоризация:**
- **Stable**: Stability ≥ 0.7
- **Variable**: Stability ≤ 0.4
- **Intermediate**: 0.4 < Stability < 0.7

### Интеграция факторов

ARCHCODE агрегирует факторы из всех модулей:
1. **CTCF strength** (из ChIP-seq или sequence motifs)
2. **Energy barriers** (G4, Z-DNA, R-loops из nonB_logic)
3. **Epigenetic marks** (methylation из epigenetic_compiler)
4. **TE motifs** (из te_grammar)
5. **Temporal factors** (из extrusion engine)

---

## Engineering Unknowns

### S1: TAD Boundary Determinism

**Вопрос:** Что определяет детерминизм границы TAD?

**Гипотезы:**
- **Hypothesis A (CTCF-centric)**: Сильные CTCF сайты → стабильные границы
- **Hypothesis B (Multi-factor)**: Комбинация CTCF + энергетические барьеры + эпигенетика
- **Hypothesis C (Temporal)**: Порядок событий экструзии определяет стабильность

**Текущая реализация:** Multi-factor модель (Hypothesis B)

### L2: Epigenetic Compiler Methylation Threshold

**Вопрос:** При каком уровне метилирования CTCF теряет способность связываться?

**Гипотезы:**
- **Hypothesis A (Binary)**: Порог 0.5 — выше → полная потеря
- **Hypothesis B (Gradual)**: Линейное снижение аффинности
- **Hypothesis C (Context-dependent)**: Зависит от других факторов

**Текущая реализация:** Gradual модель

---

## Proposed Experiments

### Experiment E-S1-L2-01: Stability Factor Decomposition

**Цель:** Определить вклад каждого фактора в стабильность границы.

**Метод:**
1. Выбрать набор границ с известной стабильностью (из Hi-C данных)
2. Для каждой границы:
   - Измерить CTCF strength
   - Обнаружить energy barriers (G4, Z-DNA)
   - Измерить methylation level
   - Идентифицировать TE motifs
3. Запустить ARCHCODE Stability Predictor
4. Сравнить предсказания с экспериментальными данными

**Метрики:**
- Correlation между предсказанной и экспериментальной стабильностью
- Feature importance (какой фактор важнее)
- Пороговые значения для каждого фактора

**Ожидаемый результат:**
- Калибровка весов факторов в формуле стабильности
- Выявление критических порогов для каждого фактора

---

### Experiment E-S1-L2-02: Hypothesis Comparison

**Цель:** Сравнить альтернативные гипотезы о детерминизме границ.

**Метод:**
1. Загрузить три гипотезы для S1:
   - Hypothesis A (CTCF-centric)
   - Hypothesis B (Multi-factor) — текущая
   - Hypothesis C (Temporal)
2. Запустить симуляцию для набора границ
3. Сравнить предсказания стабильности

**Метрики:**
- Accuracy для каждой гипотезы
- Precision/Recall для категорий (stable/variable)
- Feature importance для каждой гипотезы

**Ожидаемый результат:**
- Определение лучшей гипотезы для предсказания стабильности
- Понимание, какие факторы критичны

---

### Experiment E-S1-L2-03: Stability Threshold Sweep

**Цель:** Определить оптимальные пороги для категоризации границ.

**Метод:**
1. Запустить Stability Predictor для всех границ
2. Sweep порогов:
   - Stable threshold: [0.6, 0.7, 0.8, 0.9]
   - Variable threshold: [0.3, 0.4, 0.5, 0.6]
3. Для каждой комбинации порогов:
   - Вычислить accuracy против экспериментальных данных
   - Построить confusion matrix

**Метрики:**
- Optimal thresholds для максимальной accuracy
- Precision/Recall для каждой категории
- F1-score

**Ожидаемый результат:**
- Оптимальные пороги для категоризации
- Калибровка модели на реальных данных

---

### Experiment E-S1-L2-04: Factor Interaction Analysis

**Цель:** Исследовать взаимодействие факторов (синергия/антагонизм).

**Метод:**
1. Выбрать границы с разными комбинациями факторов:
   - Высокий CTCF + низкий methylation
   - Низкий CTCF + высокий G4
   - Высокий CTCF + высокий methylation (конфликт)
   - Низкий CTCF + низкий methylation (нестабильность)
2. Запустить Stability Predictor
3. Проанализировать взаимодействия

**Метрики:**
- Interaction effects (синергия/антагонизм)
- Non-linear эффекты
- Контекстные зависимости

**Ожидаемый результат:**
- Понимание взаимодействий факторов
- Возможная модификация модели (нелинейные члены)

---

## Implementation Plan

### Phase 1: Data Collection

**Задачи:**
1. Собрать экспериментальные данные о стабильности границ:
   - Hi-C данные (single-cell или bulk с вариабельностью)
   - CTCF ChIP-seq
   - Methylation profiles
   - TE annotations
2. Создать датасет границ с известной стабильностью

**Файлы:**
- `data/input/boundary_stability_dataset.csv`
- `data/input/experimental_stability_scores.json`

---

### Phase 2: Model Calibration

**Задачи:**
1. Запустить Experiment E-S1-L2-01 (Factor Decomposition)
2. Калибровать веса факторов в формуле стабильности
3. Определить пороговые значения

**Файлы:**
- `experiments/run_S1_L2_factor_decomposition.py`
- `config/boundary_stability.yaml` (обновить веса)

---

### Phase 3: Hypothesis Testing

**Задачи:**
1. Запустить Experiment E-S1-L2-02 (Hypothesis Comparison)
2. Сравнить альтернативные гипотезы
3. Выбрать лучшую модель

**Файлы:**
- `experiments/run_S1_L2_hypothesis_comparison.py`
- `config/structural/S1_tad_boundaries.yaml` (обновить гипотезы)

---

### Phase 4: Threshold Optimization

**Задачи:**
1. Запустить Experiment E-S1-L2-03 (Threshold Sweep)
2. Определить оптимальные пороги
3. Обновить категоризацию в StabilityCalculator

**Файлы:**
- `experiments/run_S1_L2_threshold_sweep.py`
- `src/boundary_stability/stability_calculator.py` (обновить пороги)

---

### Phase 5: Interaction Analysis

**Задачи:**
1. Запустить Experiment E-S1-L2-04 (Factor Interaction)
2. Проанализировать взаимодействия
3. Возможно, модифицировать модель (нелинейные члены)

**Файлы:**
- `experiments/run_S1_L2_interaction_analysis.py`
- `src/boundary_stability/stability_model.py` (возможная модификация)

---

## Expected Outcomes

### Scientific Insights

1. **Факторы стабильности:**
   - Ранжирование факторов по важности
   - Критические пороги для каждого фактора
   - Взаимодействия между факторами

2. **Модель предсказания:**
   - Калиброванная формула стабильности
   - Оптимальные пороги категоризации
   - Accuracy на экспериментальных данных

3. **Гипотезы:**
   - Какая гипотеза лучше объясняет данные
   - Нужны ли модификации модели

### Technical Deliverables

1. **Калиброванная модель:**
   - Обновленный `config/boundary_stability.yaml`
   - Оптимальные веса факторов
   - Пороговые значения

2. **Эксперименты:**
   - 4 экспериментальных скрипта
   - Результаты и визуализации
   - Отчеты о калибровке

3. **Документация:**
   - Обновление RS-06 с результатами
   - Методология калибровки
   - Best practices для предсказания стабильности

---

## Integration with ARCHCODE

### Current State

✅ **Boundary Stability Predictor (RS-06)**
- Мультипликативная модель стабильности
- Агрегация факторов из всех модулей
- Категоризация (stable/variable/intermediate)

✅ **VIZIR Framework**
- S1 и L2 формализованы как Engineering Unknowns
- Альтернативные гипотезы встроены
- Integrity tracking для воспроизводимости

✅ **Full Pipeline Integration**
- Stability Predictor интегрирован в pipeline
- Результаты экспортируются в JSON/CSV

### Next Steps

1. **Собрать экспериментальные данные**
2. **Запустить калибровку модели**
3. **Сравнить гипотезы**
4. **Оптимизировать пороги**
5. **Проанализировать взаимодействия**

---

## References

- RS-06: Boundary Stability Predictor
- S1: TAD Boundary Determinism (Engineering Unknown)
- L2: Epigenetic Compiler Methylation Threshold (Engineering Unknown)
- Full Pipeline Integration (RS-07 → Full Pipeline)

---

**Status:** Proposed  
**Priority:** High  
**Dependencies:** RS-06, S1, L2, Experimental Data  
**Estimated Time:** 2-3 weeks







